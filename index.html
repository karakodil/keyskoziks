<!DOCTYPE html>
<html>
<head>
    <title>Password Check</title>
</head>
<body>
    <h1>Password Verification API</h1>
    <p>Server is running!</p>
    
    <script>
        // База паролей (временная, сбрасывается при перезагрузке)
        let passwordDatabase = {};
        
        // Обработчик запросов
        self.addEventListener('fetch', function(event) {
            const url = new URL(event.request.url);
            
            // Проверяем пароль
            if (url.pathname === '/check' && event.request.method === 'POST') {
                event.respondWith(handlePasswordCheck(event.request));
            }
            // Главная страница
            else if (url.pathname === '/' || url.pathname === '/index.html') {
                event.respondWith(new Response('<h1>Password Server Works!</h1>', {
                    headers: { 'Content-Type': 'text/html' }
                }));
            }
        });
        
        async function handlePasswordCheck(request) {
            try {
                const formData = await request.formData();
                const password = formData.get('pwd');
                const deviceId = formData.get('did');
                
                console.log('Check:', password, deviceId);
                
                // Логика проверки
                if (!passwordDatabase[deviceId]) {
                    // Первый вход - сохраняем пароль
                    passwordDatabase[deviceId] = password;
                    return new Response('OK', { 
                        status: 200,
                        headers: { 
                            'Content-Type': 'text/plain',
                            'Access-Control-Allow-Origin': '*'
                        }
                    });
                } 
                else if (passwordDatabase[deviceId] === password) {
                    // Пароль верный
                    return new Response('OK', { 
                        status: 200,
                        headers: { 
                            'Content-Type': 'text/plain',
                            'Access-Control-Allow-Origin': '*'
                        }
                    });
                } 
                else {
                    // Пароль неверный
                    return new Response('INVALID', { 
                        status: 401,
                        headers: { 
                            'Content-Type': 'text/plain',
                            'Access-Control-Allow-Origin': '*'
                        }
                    });
                }
            } catch (error) {
                return new Response('ERROR', { 
                    status: 500,
                    headers: { 
                        'Content-Type': 'text/plain',
                        'Access-Control-Allow-Origin': '*'
                    }
                });
            }
        }
    </script>
</body>
</html>
